---
import { getCollection, type CollectionEntry } from 'astro:content';
import Layout from '../../layouts/Layout.astro';
import SEO from '../../components/SEO.astro';
import SchemaOrg from '../../components/SchemaOrg.astro';
import SocialShare from '../../components/SocialShare.astro';
import { Image } from 'astro:assets';
import { formatDate } from '../../utils/dateUtils';

export async function getStaticPaths() {
  const blogEntries = await getCollection('blog');
  return blogEntries.map(entry => ({
    params: { slug: entry.slug }, props: { entry },
  }));
}

interface Props {
  entry: CollectionEntry<'blog'>;
}

const { entry } = Astro.props;
const { Content } = await entry.render();

const canonicalURL = new URL(Astro.url.pathname, Astro.site).toString();
const safeCanonicalURL = canonicalURL.endsWith('/') ? canonicalURL : `${canonicalURL}/`;

// Obtener posts recientes
const allPosts = await getCollection('blog');
const recentPosts = allPosts
  .sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf())
  .filter(post => post.slug !== entry.slug)
  .slice(0, 3);

// Imagen de marcador de posición
const placeholderImage = '/images/default-og-image.jpg';

// Usa la imagen del post si está disponible, de lo contrario usa una imagen por defecto
const postImage = entry.data.image 
  ? new URL(entry.data.image, Astro.site).toString()
  : new URL(placeholderImage, Astro.site).toString();

const schemaBlogPost = {
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": entry.data.title,
  "image": postImage,
  "author": {
    "@type": "Person",
    "name": entry.data.author || "Chismesito Team"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Chismesito Blog",
    "logo": {
      "@type": "ImageObject",
      "url": new URL("/logo.png", Astro.site).href
    }
  },
  "datePublished": entry.data.pubDate.toISOString(),
  "dateModified": entry.data.updatedDate ? entry.data.updatedDate.toISOString() : entry.data.pubDate.toISOString(),
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": safeCanonicalURL
  },
  "description": entry.data.description
};
---

<Layout title={entry.data.title} description={entry.data.description}>
  <SEO 
    title={entry.data.title}
    description={entry.data.description}
    image={postImage}
    imageAlt={entry.data.imageAlt || entry.data.title}
    canonicalURL={safeCanonicalURL}
    type="article"
  />
  <SchemaOrg schema={schemaBlogPost} />
  <article class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h1 class="text-texto-principal text-balance text-center leading-tight font-bold mb-8 text-black">
      {entry.data.title}
    </h1>
    
    <Image 
      src={postImage}
      alt={entry.data.imageAlt || entry.data.title}
      width={1200} 
      height={630} 
      loading="eager"
      decoding="async"
      class="w-full h-auto rounded-lg shadow-md mb-8 object-cover" 
    />
    <p class="text-[#1c51a7] text-center mb-8">Publicado el: {formatDate(entry.data.pubDate)}</p>
    <div class="content prose lg:prose-xl mx-auto">
      <Content />
    </div>
    <div class="mt-12">
      <SocialShare url={safeCanonicalURL} title={entry.data.title} />
    </div>
  </article>

  <section class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <h2 class="text-3xl font-bold mb-8 text-gray-800">Posts Recientes</h2>
    <div class="grid gap-8 md:grid-cols-2 lg:grid-cols-3">
      {recentPosts.map((post) => (
        <article class="bg-[#f7dbed] shadow-lg rounded-lg overflow-hidden transition-transform duration-300 hover:scale-105">
          <Image 
            src={post.data.image ? new URL(post.data.image, Astro.site).toString() : new URL(placeholderImage, Astro.site).toString()}
            alt={post.data.imageAlt || post.data.title}
            width={400}
            height={200}
            class="w-full h-48 object-cover"
          />
          <div class="p-6 flex flex-col justify-between h-[300px]">
            <h3 class="text-xl font-bold mb-3 text-gray-900">{post.data.title}</h3>
            <p class="text-gray-600 mb-4 line-clamp-2">{post.data.description}</p>
            <a href={`/blog/${post.slug}/`} class="inline-block bg-black text-white py-2 px-4 rounded-3xl hover:bg-[#272727] transition-colors duration-300 ease-in-out w-fit">
              Leer más
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Layout>

<style>
  /* Estilos globales para el contenido */
  .content :global(h2) {
    @apply text-texto-sec text-balance leading-[1.3] font-bold mb-6 text-gray-800 dark:text-gray-200;
  }

  .content :global(h3) {
    @apply text-2xl sm:text-3xl font-semibold my-4 text-gray-800 dark:text-gray-200;
  }

  .content :global(h4) {
    @apply text-xl sm:text-2xl font-semibold my-4 text-gray-800 dark:text-gray-200;
  }
  
  .content :global(p) {
    @apply text-gray-700 dark:text-gray-300 leading-relaxed;
  }

  .content :global(ul), .content :global(ol) {
    @apply ml-6 mb-6 list-disc;
  }

  .content :global(li) {
    @apply mb-2 text-gray-700 dark:text-gray-300;
  }

  .content :global(a) {
    @apply text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200 transition-colors duration-300;
  }

  /* Estilos para bloques de código */
  .content :global(pre) {
    @apply bg-gray-100 dark:bg-gray-800 p-4 rounded-md overflow-x-auto mb-6 text-sm;
  }

  .content :global(code) {
    @apply font-mono text-sm bg-gray-100 dark:bg-gray-800 px-1 py-0.5 rounded;
  }

  /* Estilos para imágenes dentro del contenido */
  .content :global(img) {
    @apply rounded-lg shadow-md my-8 mx-auto;
  }

  /* Estilos para citas */
  .content :global(blockquote) {
    @apply border-l-4 border-[#1c51a7] p-4 italic my-6 text-gray-600 dark:text-gray-400 bg-[#6a8bd173] rounded-br-[7px] rounded-tr-[7px];
  }

  /* Estilos para tablas */
  .content :global(table) {
    @apply w-full border-collapse mb-6;
  }

  .content :global(th), .content :global(td) {
    @apply border border-gray-300 dark:border-gray-700 px-4 py-2 text-left;
  }

  .content :global(th) {
    @apply bg-gray-100 dark:bg-gray-800 font-semibold;
  }
</style>